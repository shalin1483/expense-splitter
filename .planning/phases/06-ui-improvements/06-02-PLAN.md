---
phase: 06-ui-improvements
plan: "02"
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/hooks/useDarkMode.ts
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "A sun/moon toggle button appears in the app header"
    - "Clicking the toggle switches the app between light and dark color schemes"
    - "Dark mode persists across page refresh (stored in localStorage under key 'theme')"
    - "On first load with no localStorage value, the app respects prefers-color-scheme"
    - "The .dark class is toggled on the <html> element (not a parent div)"
    - "No flash of wrong theme on page load (initial state computed synchronously)"
  artifacts:
    - path: "src/hooks/useDarkMode.ts"
      provides: "useDarkMode hook with theme state and toggle function"
      contains: "localStorage.setItem('theme'"
    - path: "src/App.tsx"
      provides: "App shell with dark mode toggle in header, Toaster mounted"
      contains: "useDarkMode"
  key_links:
    - from: "src/hooks/useDarkMode.ts"
      to: "document.documentElement"
      via: "classList.toggle('dark', theme === 'dark')"
      pattern: "classList.toggle"
    - from: "src/App.tsx"
      to: "src/hooks/useDarkMode.ts"
      via: "import { useDarkMode }"
      pattern: "useDarkMode"
---

<objective>
Create the useDarkMode hook and wire it into App.tsx with a header toggle button, plus mount the Sonner Toaster component globally.

Purpose: Dark mode (ENH-02) and the global toast infrastructure both live in App.tsx — the root of the component tree. Both are trivially small but must be done together since they touch the same file. The useDarkMode hook is a pure utility with no JSX dependency, so it can be written first.

Output: src/hooks/useDarkMode.ts (new file), src/App.tsx (updated with toggle + Toaster).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ui-improvements/06-RESEARCH.md
@.planning/phases/06-ui-improvements/06-01-SUMMARY.md
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useDarkMode hook</name>
  <files>src/hooks/useDarkMode.ts</files>
  <action>
Create the directory `src/hooks/` if it doesn't exist, then create `src/hooks/useDarkMode.ts` with the following exact implementation:

```typescript
import { useState, useEffect } from 'react';

type Theme = 'light' | 'dark';

/**
 * Reads persisted theme from localStorage, falling back to OS preference.
 * Called synchronously during useState initialization to avoid flash.
 */
function getInitialTheme(): Theme {
  const stored = localStorage.getItem('theme') as Theme | null;
  if (stored === 'light' || stored === 'dark') return stored;
  return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
}

/**
 * Manages dark/light theme with localStorage persistence.
 * Toggles the 'dark' class on <html> so Tailwind dark: variants apply.
 */
export function useDarkMode() {
  // Initialize synchronously (function form) to avoid light-flash on load
  const [theme, setTheme] = useState<Theme>(getInitialTheme);

  useEffect(() => {
    document.documentElement.classList.toggle('dark', theme === 'dark');
    localStorage.setItem('theme', theme);
  }, [theme]);

  const toggle = () => setTheme(t => (t === 'dark' ? 'light' : 'dark'));

  return { theme, toggle };
}
```

Key details:
- `useState(getInitialTheme)` — passes the function reference (not the result) so it runs once synchronously during first render, preventing flash
- `document.documentElement` — targets `<html>`, not `<body>`, so Tailwind's `@custom-variant dark (&:where(.dark, .dark *))` propagates correctly
- Uses `classList.toggle(class, force)` boolean overload for clarity
  </action>
  <verify>
Run: `npx tsc --noEmit 2>&1 | grep "useDarkMode"`
Expected: No TypeScript errors for this file.
  </verify>
  <done>src/hooks/useDarkMode.ts exists, exports useDarkMode, compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Update App.tsx with dark mode toggle and Toaster</name>
  <files>src/App.tsx</files>
  <action>
Replace the entire contents of `src/App.tsx` with the following. This adds:
1. Dark mode toggle button in the header (sun/moon icon from lucide-react)
2. Tailwind utility classes on the header and layout elements
3. Toaster from sonner mounted at the root level (required for toast.success() calls to work in any component)

```tsx
import { useState } from 'react';
import { Moon, Sun } from 'lucide-react';
import { Toaster } from 'sonner';
import { BillWizard } from './components/BillWizard';
import { HistoryList } from './components/HistoryList';
import { useDarkMode } from './hooks/useDarkMode';

export default function App() {
  const [view, setView] = useState<'wizard' | 'history'>('wizard');
  const { theme, toggle } = useDarkMode();

  return (
    <div className="min-h-screen bg-white dark:bg-zinc-950 text-zinc-900 dark:text-zinc-50">
      <div className="max-w-[480px] mx-auto px-4 py-4">
        <header className="flex justify-between items-center mb-4">
          <h1 className="text-2xl font-semibold tracking-tight">Expense Splitter</h1>
          <div className="flex items-center gap-2">
            <button
              onClick={() => setView(view === 'wizard' ? 'history' : 'wizard')}
              className="text-sm px-3 py-2 border border-brand text-brand rounded-md hover:bg-brand-light dark:hover:bg-zinc-800 transition-colors min-h-[36px]"
            >
              {view === 'wizard' ? 'History' : 'Back to Split'}
            </button>
            <button
              onClick={toggle}
              aria-label={theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode'}
              className="p-2 rounded-md text-zinc-500 hover:text-zinc-900 dark:hover:text-zinc-50 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors min-h-[36px] min-w-[36px] flex items-center justify-center"
            >
              {theme === 'dark' ? <Sun size={18} /> : <Moon size={18} />}
            </button>
          </div>
        </header>

        {view === 'wizard' && <BillWizard />}
        {view === 'history' && <HistoryList onBack={() => setView('wizard')} />}
      </div>

      <Toaster position="bottom-center" richColors />
    </div>
  );
}
```

Notes:
- The outer `<div>` with `min-h-screen` replaces the old `<main>` and handles background color for both themes
- `max-w-[480px] mx-auto px-4 py-4` replaces the old `body { max-width: 480px; padding: 16px }` — these are now on the layout div, not on body
- `text-brand` and `border-brand` use the `--color-brand` CSS variable defined in App.css `@theme`
- `Toaster` mounted here makes `toast.success()` / `toast.error()` available anywhere in the component tree
- `lucide-react` is installed by shadcn/ui automatically — no separate install needed
  </action>
  <verify>
Run: `npm run build 2>&1 | tail -20`
Expected: Build succeeds with no errors.
Run: `npm test 2>&1 | tail -20`
Expected: All tests pass (App.tsx changes don't affect unit tests of individual components).
  </verify>
  <done>App.tsx renders correctly, dark mode toggle button appears, Toaster is mounted, build and tests pass.</done>
</task>

</tasks>

<verification>
1. `npm run build` exits 0
2. `npm test` exits 0 — all component tests still pass
3. `grep "useDarkMode" src/App.tsx` returns a match
4. `grep "Toaster" src/App.tsx` returns a match
5. `grep "classList.toggle" src/hooks/useDarkMode.ts` returns a match
6. `grep "localStorage.setItem" src/hooks/useDarkMode.ts` returns a match
</verification>

<success_criteria>
- useDarkMode hook exists at src/hooks/useDarkMode.ts, initializes theme synchronously, persists to localStorage, toggles .dark class on document.documentElement
- App.tsx has dark mode toggle button with sun/moon icon
- App.tsx has Toaster mounted (enables toast.success() calls in ResultsStep)
- Header layout uses Tailwind utility classes
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-ui-improvements/06-02-SUMMARY.md` following the summary template.
</output>
