---
phase: 04-tax-tip-and-assignment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/AssignmentStep.tsx
  - src/components/AssignmentStep.test.tsx
autonomous: true

must_haves:
  truths:
    - "User can tap person badges on each item to assign/unassign people"
    - "Shared items (2+ people assigned) show 'Split equally' default label"
    - "User can open custom split editor for shared items and enter percentages"
    - "Custom split validates that percentages total exactly 100%"
    - "Save is disabled when percentages do not total 100%"
    - "User can revert custom split back to equal split"
  artifacts:
    - path: "src/components/AssignmentStep.tsx"
      provides: "Item assignment UI with tap-to-toggle badges and custom split editor"
      min_lines: 120
      exports: ["AssignmentStep", "canProceedFromAssignment"]
    - path: "src/components/AssignmentStep.test.tsx"
      provides: "Unit tests for assignment validation and custom split logic"
      min_lines: 30
  key_links:
    - from: "src/components/AssignmentStep.tsx"
      to: "src/stores/billStore.ts"
      via: "useItems, usePeople, useAssignments, useBillActions hooks"
      pattern: "use(Items|People|Assignments|BillActions)"
    - from: "src/components/AssignmentStep.tsx"
      to: "src/stores/billStore.ts"
      via: "assignItem action for toggle, setCustomSplit/clearCustomSplit for overrides"
      pattern: "(assignItem|setCustomSplit|clearCustomSplit)"
---

<objective>
Build the AssignmentStep component where users assign items to people using tap-to-toggle person badges, with optional custom split editor for shared items.

Purpose: This is the core interaction of the bill splitter -- connecting items to people. Without assignment, the app cannot calculate who owes what. This covers requirements ITEM-02 (assign items to people), ITEM-03 (equal split default), and ITEM-04 (custom split override).

Output: AssignmentStep.tsx component with embedded CustomSplitEditor, plus canProceedFromAssignment validation helper.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/stores/billStore.ts
@src/lib/types/bill.ts
@src/lib/types/money.ts
@src/lib/calculations/split.ts
@src/components/PeopleStep.tsx
@src/components/ItemsStep.tsx
@src/App.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AssignmentStep with tap-to-toggle person badges per item</name>
  <files>src/components/AssignmentStep.tsx</files>
  <action>
Create AssignmentStep component following established patterns from PeopleStep.tsx and ItemsStep.tsx.

**Layout:** Item-centric view. For each item in the store, render:
1. Item header row: item name + formatted price (using formatCurrency)
2. Person badges row: one button per person in the store, styled as tap-to-toggle badges
3. Assignment summary: if people are assigned, show "Split equally among {names}" or "Custom split" indicator

**Toggle logic:**
- Import useItems, usePeople, useAssignments, useBillActions from billStore
- togglePersonOnItem(itemId, personId): read current personIds from assignments[itemId], add or remove the personId, call assignItem(itemId, newPersonIds)
- If newPersonIds becomes empty, assignItem will delete the assignment (already handled in store)

**Person badges:**
- Use `<button>` elements (not divs) for accessibility
- Add `aria-pressed={isAssigned}` for screen reader state
- Add `role="group"` and `aria-label="Assign {item.name} to people"` on badge container
- CSS class: `person-badge assigned` when active, `person-badge unassigned` when inactive
- Minimum 44px height for mobile touch targets (match existing button styles)

**Custom split section (per item):**
- Show "Custom Split" button only when item has 2+ people assigned AND no custom split exists
- Show "Custom split applied" label + "Revert to equal" button when custom split exists
- Use local state `editingCustomSplitItemId` to track which item's editor is open
- When "Custom Split" button clicked, set editingCustomSplitItemId to that item's id
- Render CustomSplitEditor inline (see Task 2's action for details, but include in same file)
- When custom split saved or cancelled, clear editingCustomSplitItemId

**CustomSplitEditor (inline component in same file):**
- Props: itemId, itemPriceInCents, assignedPeople (array of {id, name}), onSave, onCancel
- Local state: `percentages` as Record<string, number> initialized to equal split (Math.floor(100 / count))
- For each assigned person: render name + number input (type="number", min=0, max=100, step=1)
- Show running total: "Total: {sum}%" with valid/invalid styling
- isValid = sum of all percentages === 100 (integer math, no floating-point issues)
- Save button: disabled when !isValid. On save, convert percentages to cents:
  - For each person: amountInCents = Math.round((itemPriceInCents * percentage) / 100)
  - Check if sum of amounts equals itemPriceInCents. If off by 1 cent, adjust the person with the largest percentage by the difference
  - Call onSave with the CustomSplit array
- Cancel button: call onCancel

**Validation helper:**
- Export canProceedFromAssignment(items, assignments): boolean
- Returns true if at least one item has an assignment with personIds.length > 0
- This matches the pattern of canProceedFromPeople and canProceedFromItems

**Styling (inline or className-based, match existing App.css patterns):**
- .item-assignment: margin-bottom 1rem, padding 12px, border 1px solid #eee, border-radius 4px
- .person-badges: display flex, flex-wrap wrap, gap 8px, margin-top 8px
- .person-badge: padding 8px 16px, border-radius 20px, font-size 14px, min-height 44px, border 2px solid #2563eb, background white, color #2563eb, cursor pointer
- .person-badge.assigned: background #2563eb, color white
- .custom-split-editor: margin-top 12px, padding 12px, background #f9fafb, border-radius 4px
- .split-total.valid: color #16a34a
- .split-total.invalid: color #dc2626

Do NOT add styles to App.css in this task -- add them in Plan 02 when BillWizard is extended (keeps file ownership clean). Instead, use a `<style>` tag within the component or inline styles for now. Preference: add a dedicated CSS section at the bottom of AssignmentStep.tsx using an object-style approach or include styles inline on elements. Actually, follow the simplest approach: create the CSS as inline styles using style={{}} props on elements, since App.css is modified in Plan 02 and we want clean file ownership.

Wait -- reconsidering. The cleaner pattern matching the codebase is to add CSS classes and include them in App.css. Since Plan 02 also modifies App.css, this creates a file conflict. Better approach: this plan creates a separate CSS file `src/components/AssignmentStep.css` and imports it. This keeps file ownership clean.

Final approach: Create `src/components/AssignmentStep.css` with all assignment-specific styles. Import it at top of AssignmentStep.tsx.
  </action>
  <verify>
Run `npx tsc --noEmit` -- TypeScript compiles with 0 errors.
Run `npx vitest run` -- all existing tests still pass (no regressions).
Manually verify AssignmentStep.tsx exports both AssignmentStep and canProceedFromAssignment.
  </verify>
  <done>
AssignmentStep renders items with person badges. Tapping a badge toggles assignment. Shared items show custom split button. CustomSplitEditor validates percentages sum to 100%. canProceedFromAssignment returns true when at least one item is assigned.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for assignment validation and custom split logic</name>
  <files>src/components/AssignmentStep.test.tsx</files>
  <action>
Create test file for AssignmentStep following established test patterns from PeopleStep.test.tsx and ItemsStep.test.tsx.

**Tests for canProceedFromAssignment:**
1. Returns false when no assignments exist (empty Record)
2. Returns false when assignments exist but all have empty personIds arrays
3. Returns true when at least one assignment has personIds.length > 0
4. Returns true when multiple assignments have people assigned

**Tests for custom split percentage validation (if CustomSplitEditor is exported or testable):**
5. Equal split initialization: 3 people -> 33, 33, 34 (or 33, 33, 33 -- either is valid as long as documented)
6. Valid custom split: percentages summing to exactly 100 are accepted
7. Invalid custom split: percentages summing to 99 or 101 are rejected

Import canProceedFromAssignment from AssignmentStep. Use standard vitest imports (describe, it, expect).
For custom split tests, test the cents conversion logic: given an item price and percentages, verify the resulting cents amounts sum to the item price. This can be a pure function test if the conversion logic is extracted, or an integration-style test if testing the component.

Prefer testing the pure validation function canProceedFromAssignment thoroughly. The component's interactive behavior (toggle, custom split editor) will be verified via the human checkpoint in Plan 02.
  </action>
  <verify>
Run `npx vitest run` -- all tests pass including new ones.
New test count: at least 4 new tests for canProceedFromAssignment.
  </verify>
  <done>
canProceedFromAssignment has 4+ unit tests covering empty, no-assignment, single-assignment, and multi-assignment cases. All tests pass alongside existing 121 tests.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with 0 errors
- `npx vitest run` passes all tests (existing 121 + new assignment tests)
- AssignmentStep.tsx renders items from store with person badges
- Toggle behavior: tapping badge adds/removes person from item assignment
- Custom split editor appears for items with 2+ assigned people
- Custom split validates sum === 100%
- canProceedFromAssignment exported and tested
</verification>

<success_criteria>
1. AssignmentStep component renders all items with tap-to-toggle person badges
2. Tapping a person badge on an item calls assignItem with updated personIds
3. Items with 2+ people show "Custom Split" option
4. CustomSplitEditor validates percentages sum to exactly 100%
5. Save converts percentages to cents with rounding correction
6. canProceedFromAssignment(items, assignments) returns correct boolean
7. All existing + new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-tax-tip-and-assignment/04-01-SUMMARY.md`
</output>
