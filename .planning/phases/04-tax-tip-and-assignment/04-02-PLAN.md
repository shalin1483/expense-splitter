---
phase: 04-tax-tip-and-assignment
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/TaxTipStep.tsx
  - src/components/TaxTipStep.test.tsx
  - src/components/BillWizard.tsx
  - src/components/BillWizard.test.tsx
  - src/App.css
autonomous: false

must_haves:
  truths:
    - "User can enter tax as a percentage rate"
    - "User can enter tax as an exact dollar amount"
    - "User can select tip from presets (15%, 18%, 20%)"
    - "User can enter a custom tip percentage"
    - "Wizard shows 4 steps: People, Items, Assignment, Tax & Tip"
    - "Wizard prevents advancing from Assignment without at least one item assigned"
    - "Tax and tip configuration stored in Zustand for downstream calculation"
  artifacts:
    - path: "src/components/TaxTipStep.tsx"
      provides: "Tax mode toggle and tip preset/custom configuration"
      min_lines: 80
      exports: ["TaxTipStep"]
    - path: "src/components/TaxTipStep.test.tsx"
      provides: "Unit tests for tax/tip validation"
      min_lines: 20
    - path: "src/components/BillWizard.tsx"
      provides: "Extended wizard with 4 steps and validation gates"
      exports: ["BillWizard"]
    - path: "src/components/BillWizard.test.tsx"
      provides: "Updated wizard tests covering 4-step flow"
  key_links:
    - from: "src/components/TaxTipStep.tsx"
      to: "src/stores/billStore.ts"
      via: "useTaxInput, useTipRate, useBillActions hooks"
      pattern: "use(TaxInput|TipRate|BillActions)"
    - from: "src/components/TaxTipStep.tsx"
      to: "src/stores/billStore.ts"
      via: "setTaxInput and setTipRate actions"
      pattern: "(setTaxInput|setTipRate)"
    - from: "src/components/BillWizard.tsx"
      to: "src/components/AssignmentStep.tsx"
      via: "import AssignmentStep and canProceedFromAssignment"
      pattern: "import.*AssignmentStep"
    - from: "src/components/BillWizard.tsx"
      to: "src/components/TaxTipStep.tsx"
      via: "import TaxTipStep"
      pattern: "import.*TaxTipStep"
---

<objective>
Build the TaxTipStep component for tax/tip configuration and extend BillWizard to include Assignment and Tax/Tip as steps 3 and 4 of the wizard flow.

Purpose: Completes the Phase 4 UI -- users configure tax (rate or exact amount) and tip (preset or custom percentage), and the wizard enforces the full People -> Items -> Assignment -> Tax/Tip flow with validation gates. This covers requirements TAX-01, TAX-02, TIP-01, TIP-02. Requirements TAX-03 and TIP-03 (proportional distribution) are already implemented in Phase 1 calculation functions and will be wired in Phase 5's ResultsStep.

Output: TaxTipStep.tsx, updated BillWizard.tsx with 4 steps, updated App.css with assignment and tax/tip styles, and a human-verified mobile flow.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-tax-tip-and-assignment/04-01-SUMMARY.md

@src/stores/billStore.ts
@src/lib/types/bill.ts
@src/lib/types/money.ts
@src/lib/calculations/tax.ts
@src/lib/calculations/tip.ts
@src/components/BillWizard.tsx
@src/components/AssignmentStep.tsx
@src/App.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TaxTipStep component with tax mode toggle and tip presets</name>
  <files>
    src/components/TaxTipStep.tsx
    src/components/TaxTipStep.test.tsx
  </files>
  <action>
Create TaxTipStep component combining tax and tip configuration in a single wizard step. Follow established patterns from PeopleStep/ItemsStep (local useState for draft values, Zustand actions for commits).

**Tax Configuration Section:**
- Heading: "Tax"
- Radio button group (role="radiogroup", aria-label="Tax input mode") toggling between:
  - "Tax Rate (%)" mode: number input for percentage (inputMode="decimal", step="0.1", min="0", max="100", placeholder="8.0")
  - "Exact Amount ($)" mode: number input for dollar amount (inputMode="decimal", step="0.01", min="0", placeholder="0.00")
- Local state: `taxMode` ('rate' | 'exact'), `taxRateStr` (string), `taxExactStr` (string)
- On input change: immediately call setTaxInput with the appropriate TaxInput discriminated union value:
  - Rate mode: parse percentage, if valid number >= 0, call setTaxInput({ type: 'rate', rate: percentage / 100 })
  - Exact mode: parse dollars, if valid number >= 0, call setTaxInput({ type: 'exact', amount: toCents(dollars) })
  - If empty/invalid, call setTaxInput(null) to clear
- Import toCents from '@/lib/types/money'
- Initialize local state from existing store values (useTaxInput) on mount so state persists across wizard navigation
- "No Tax" button: calls setTaxInput(null), clears local input strings
- Preview text showing current config: "Tax: 8.0%" or "Tax: $8.25" or "No tax configured"

**Tip Configuration Section:**
- Heading: "Tip"
- Preset buttons row: 15%, 18%, 20% as styled toggle buttons (not radio inputs -- use buttons with aria-pressed for better mobile UX)
- Tapping a preset: calls setTipRate(rate), highlights that button as active
- Custom percentage input below presets: number input (inputMode="decimal", step="0.1", min="0", max="100")
- Local state: `tipPercentageStr` (string) initialized from store's tipRate * 100
- On custom input change: parse to number, if valid call setTipRate(value / 100)
- When a preset is tapped, update the custom input display to match
- Active state: determine if current tipRate matches a preset; if so highlight that preset button
- Note: store's setTipRate clamps to 0-1 range (already implemented)

**No "Apply" button needed** -- tax and tip values are written to store on every valid input change. This matches the real-time pattern and avoids the "forgot to click Apply" pitfall mentioned in research.

**Tests (TaxTipStep.test.tsx):**
1. Tax rate mode: valid percentage string converts to correct TaxInput
2. Tax exact mode: valid dollar string converts to correct TaxInput with toCents
3. Tip preset values: each preset maps to correct decimal rate
4. Default tip rate: store initializes with 0.18 (verify initial state)

Import useTaxInput, useTipRate, useBillActions from billStore. Import toCents from money.ts. Import TaxInput type from bill.ts.
  </action>
  <verify>
Run `npx tsc --noEmit` -- TypeScript compiles with 0 errors.
Run `npx vitest run` -- all tests pass including new TaxTipStep tests.
  </verify>
  <done>
TaxTipStep renders tax radio toggle (rate vs exact) with appropriate input, tip presets (15/18/20%) with custom input, and writes values to Zustand store on every valid change. Tests verify conversion logic and preset mapping.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend BillWizard to 4 steps with assignment and tax/tip validation gates</name>
  <files>
    src/components/BillWizard.tsx
    src/components/BillWizard.test.tsx
    src/App.css
  </files>
  <action>
Update BillWizard to support 4 wizard steps and add all CSS styles for Phase 4 components.

**BillWizard changes:**
- Update WizardStep type: 'people' | 'items' | 'assignment' | 'taxtip'
- Update STEPS array: ['people', 'items', 'assignment', 'taxtip']
- Update stepLabels: { people: 'People', items: 'Items', assignment: 'Assign Items', taxtip: 'Tax & Tip' }
- Import AssignmentStep, canProceedFromAssignment from '@/components/AssignmentStep'
- Import TaxTipStep from '@/components/TaxTipStep'
- Import useAssignments from '@/stores/billStore'
- Add assignments to the destructured store values
- Update canProceed record:
  - people: canProceedFromPeople(people)
  - items: canProceedFromItems(items)
  - assignment: canProceedFromAssignment(items, assignments)
  - taxtip: true (tax/tip always has valid defaults: null tax + 18% tip)
- Add rendering cases: assignment -> <AssignmentStep />, taxtip -> <TaxTipStep />
- Update auto-advance logic: check each step in order, advance to first incomplete step
  - If people.length >= 2 AND items.length >= 1 AND hasAssignments: advance to 'taxtip'
  - If people.length >= 2 AND items.length >= 1: advance to 'assignment'
  - If people.length >= 2: advance to 'items'
  - hasAssignments = items.some(item => assignments[item.id]?.personIds.length > 0)

**BillWizard test updates:**
- Update existing STEPS ordering test: verify 4 steps in correct order
- Add test: canProceedFromAssignment gate blocks advancement with no assignments
- Add test: canProceedFromAssignment gate allows advancement with at least one assignment
- Add test: taxtip step always allows proceeding (returns true)

**App.css additions (append to existing file):**
Add styles for all Phase 4 components. Read App.css first to understand existing patterns.

```css
/* Assignment Step */
.item-assignment {
  margin-bottom: 1rem;
  padding: 12px;
  border: 1px solid #eee;
  border-radius: 8px;
}

.item-assignment .item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.item-assignment .item-header h3 {
  margin: 0;
  font-size: 1rem;
}

.person-badges {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 8px;
}

.person-badge {
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 0.875rem;
  min-height: 44px;
  border: 2px solid #2563eb;
  background: white;
  color: #2563eb;
  cursor: pointer;
  display: flex;
  align-items: center;
}

.person-badge:hover {
  background: #eff6ff;
}

.person-badge.assigned {
  background: #2563eb;
  color: white;
}

.person-badge.assigned:hover {
  background: #1d4ed8;
}

.assignment-summary {
  font-size: 0.875rem;
  color: #666;
  margin-top: 8px;
}

.custom-split-section {
  margin-top: 8px;
}

.custom-split-editor {
  margin-top: 12px;
  padding: 12px;
  background: #f9fafb;
  border-radius: 4px;
}

.custom-split-editor label {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 0;
}

.custom-split-editor input[type="number"] {
  width: 80px;
  text-align: right;
}

.split-total {
  font-weight: bold;
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid #ddd;
}

.split-total.valid {
  color: #16a34a;
}

.split-total.invalid {
  color: #dc2626;
}

/* Tax & Tip Step */
.tax-tip-step section {
  margin-bottom: 1.5rem;
}

.tax-tip-step h3 {
  margin: 0 0 0.75rem 0;
}

.tax-mode {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
}

.tax-mode label {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 0.9375rem;
}

.tip-presets {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

.tip-preset {
  flex: 1;
  padding: 12px;
  font-size: 1rem;
  border: 2px solid #2563eb;
  border-radius: 8px;
  background: white;
  color: #2563eb;
  min-height: 44px;
  cursor: pointer;
  text-align: center;
}

.tip-preset:hover {
  background: #eff6ff;
}

.tip-preset.active {
  background: #2563eb;
  color: white;
}

.tip-preset.active:hover {
  background: #1d4ed8;
}

.tax-preview, .tip-preview {
  font-size: 0.875rem;
  color: #666;
  margin-top: 8px;
}

.no-tax-btn {
  background: transparent;
  color: #666;
  border: 1px solid #ccc;
  font-size: 0.875rem;
  margin-left: 8px;
}

.no-tax-btn:hover {
  background: #f3f4f6;
}

.tax-input-row, .tip-input-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

.tax-input-row input, .tip-input-row input {
  width: 100px;
}

.input-suffix {
  font-size: 0.875rem;
  color: #666;
}
```

Also remove the inline styles from AssignmentStep.tsx if Plan 01 used inline styles, replacing them with these CSS classes. If Plan 01 created a separate AssignmentStep.css file, remove that file and consolidate into App.css for consistency with the rest of the project.
  </action>
  <verify>
Run `npx tsc --noEmit` -- TypeScript compiles with 0 errors.
Run `npx vitest run` -- all tests pass including updated BillWizard tests.
Verify BillWizard renders 4 steps in correct order.
  </verify>
  <done>
BillWizard shows "Step X of 4" with all four step components rendering. Validation gates: people (2+ required), items (1+ required), assignment (1+ item assigned required), tax/tip (always valid). Auto-advance works through all 4 steps. All CSS for Phase 4 consolidated in App.css.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Phase 4 wizard flow on mobile viewport</name>
  <files>src/components/BillWizard.tsx</files>
  <action>
Ensure dev server is running (`npx vite dev` or confirm already running). This is a human verification checkpoint -- no code changes needed. The user will manually test the complete Phase 4 wizard flow on a mobile viewport to verify all interactive behaviors work correctly.

What was built in Tasks 1-2:
- AssignmentStep: item-centric assignment with tap-to-toggle person badges, custom split editor with percentage validation
- TaxTipStep: tax mode toggle (rate/exact) with real-time store updates, tip presets (15/18/20%) with custom input
- BillWizard: extended to 4 steps with validation gates and auto-advance
  </action>
  <verify>
Human verifies the following on mobile viewport (iPhone SE / 375px):

1. Open http://localhost:5173 in browser DevTools mobile viewport
2. **People step:** Add 3 people (Alice, Bob, Carol). Click Next.
3. **Items step:** Add "Pizza" at $20.00, "Salad" at $10.00, "Dessert" at $15.00. Click Next.
4. **Assignment step:**
   - All 3 items shown with person badges for Alice, Bob, Carol
   - Tap "Alice" and "Bob" on Pizza -- both badges highlight blue
   - Tap "Alice" on Salad -- only Alice badge highlighted
   - Tap all three on Dessert -- all highlighted
   - "Custom Split" button appears on Pizza and Dessert (2+ people)
   - Open custom split on Dessert: ~33/33/34% defaults
   - Change to 50/25/25 -- total shows "100%" in green, save works
   - Try invalid 40/40 split on Pizza -- save disabled, total red
   - Cancel invalid split
   - Next enabled (items assigned)
5. **Tax & Tip step:**
   - Tax defaults to rate mode, enter 8.5 -- preview shows "Tax: 8.5%"
   - Switch to exact, enter 5.25 -- preview shows "Tax: $5.25"
   - "No Tax" clears config
   - Tip 18% preset highlighted by default
   - Tap 20% -- highlights, 18% unhighlights
   - Custom 22% -- presets unhighlight
6. **Navigation:** Back/forward preserves all state
7. **Touch targets:** All >= 44px
8. **Refresh:** Auto-advances to furthest completed step
  </verify>
  <done>
User types "approved" confirming all Phase 4 interactive behaviors work correctly on mobile viewport, or describes specific issues to fix.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with 0 errors
- `npx vitest run` passes all tests (existing + new TaxTipStep + updated BillWizard)
- 4-step wizard flow works: People -> Items -> Assignment -> Tax & Tip
- Assignment step: tap-to-toggle badges, custom split with validation
- Tax step: rate/exact toggle with real-time store update
- Tip step: presets (15/18/20%) + custom input
- Back/forward navigation preserves all state
- Auto-advance on refresh works through all 4 steps
- Mobile viewport (375px): all touch targets >= 44px
</verification>

<success_criteria>
1. TaxTipStep renders tax radio toggle (rate vs exact) and tip presets (15/18/20%) with custom input
2. Tax input changes immediately write to Zustand store (no Apply button needed)
3. Tip preset selection writes to store, custom input overrides presets
4. BillWizard orchestrates 4 steps with correct validation gates
5. Assignment gate: at least 1 item must be assigned to proceed
6. Tax/Tip gate: always valid (reasonable defaults exist)
7. Auto-advance on refresh detects furthest completed step
8. Human verified complete flow on mobile viewport
9. All tests pass (existing + new)
</success_criteria>

<output>
After completion, create `.planning/phases/04-tax-tip-and-assignment/04-02-SUMMARY.md`
</output>
