---
phase: 05-results-and-history
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/ResultsStep.tsx
  - src/components/ResultsStep.test.tsx
  - src/components/HistoryList.tsx
  - src/components/HistoryList.test.tsx
  - src/App.tsx
  - src/App.css
autonomous: false

must_haves:
  truths:
    - "User can save completed split to history"
    - "User can view list of past splits and recall details"
  artifacts:
    - path: "src/components/ResultsStep.tsx"
      provides: "Save to History button that snapshots current bill to historyStore"
      contains: "saveBill"
    - path: "src/components/HistoryList.tsx"
      provides: "List of past splits with date, total, people count"
      min_lines: 40
    - path: "src/App.tsx"
      provides: "App shell with toggle between active bill wizard and history list"
      contains: "HistoryList"
  key_links:
    - from: "src/components/ResultsStep.tsx"
      to: "src/stores/historyStore.ts"
      via: "useHistoryActions().saveBill"
      pattern: "saveBill"
    - from: "src/components/HistoryList.tsx"
      to: "src/stores/historyStore.ts"
      via: "useSavedBills, useHistoryActions"
      pattern: "useSavedBills|useHistoryActions"
    - from: "src/App.tsx"
      to: "src/components/HistoryList.tsx"
      via: "import and render"
      pattern: "HistoryList"
---

<objective>
Add Save to History functionality in ResultsStep and create HistoryList component for viewing past splits, completing all Phase 5 requirements.

Purpose: Users need to save completed splits for reference and browse past splits. This closes RESULT-03 and completes the app's core feature set.

Output: Save button in ResultsStep, HistoryList component, App shell with history toggle, human verification of full flow
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-results-and-history/05-01-SUMMARY.md
@src/stores/historyStore.ts
@src/lib/types/bill.ts
@src/components/ResultsStep.tsx
@src/App.tsx
@src/App.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Save to History in ResultsStep and create HistoryList component</name>
  <files>
    src/components/ResultsStep.tsx
    src/components/ResultsStep.test.tsx
    src/components/HistoryList.tsx
    src/components/HistoryList.test.tsx
    src/App.tsx
    src/App.css
  </files>
  <action>
**Part A: Add Save to History button in `src/components/ResultsStep.tsx`**

1. Import `useHistoryActions` from `@/stores/historyStore` and `useBillActions` from `@/stores/billStore`
2. Add a "Save to History" button below the person breakdowns
3. On click, call `historyActions.saveBill(billData, label)` where:
   - `billData` is constructed from current store state: `{ people, items, assignments, taxInput, tipRate, totalInCents: summary.grandTotal }`
   - `label` is optional -- skip for now (no label input needed, per research: "Start with view-only")
4. After saving, show confirmation feedback: change button text to "Saved!" with a green check, disable it for 2 seconds, then re-enable. Use a simple `useState` for the saved state and `setTimeout` to reset.
5. Also add a "New Split" button that calls `billActions.reset()` to clear the current bill and start fresh. This should be next to or below the Save button.

**Part B: Create `src/components/HistoryList.tsx`**

Component that displays saved splits from historyStore.

```tsx
export function HistoryList({ onBack }: { onBack: () => void }) {
  const bills = useSavedBills();
  const { deleteBill, clearHistory } = useHistoryActions();
  // ...
}
```

Structure:
- Header with "Past Splits" title and a "Back to Split" button (calls `onBack`)
- If no bills: show empty state message "No saved splits yet. Complete a split and save it to see it here."
- For each saved bill, render a card/row showing:
  - Date: format timestamp using `Intl.DateTimeFormat('en-US', { dateStyle: 'medium', timeStyle: 'short' }).format(bill.timestamp)`
  - Grand total: `formatCurrency(bill.totalInCents)`
  - People count: `${bill.people.length} people`
  - Items count: `${bill.items.length} items`
  - Delete button (small, secondary style) to remove individual entry
- Each bill card is a `<details>`/`<summary>` that expands to show the full bill breakdown:
  - List each person and their items (recompute using `computePersonTotals` from Plan 01's utility)
  - Show tax and tip configuration
- "Clear All History" button at the bottom (only if history is not empty), with a confirm step: first click changes text to "Are you sure?", second click actually clears

CSS class names: `.history-list`, `.history-empty`, `.history-item`, `.history-item__summary`, `.history-item__details`, `.history-meta`, `.clear-history-btn`

**Part C: Update `src/App.tsx`**

Add a simple view toggle between the bill wizard and history list.

```tsx
export default function App() {
  const [view, setView] = useState<'wizard' | 'history'>('wizard');

  return (
    <main>
      <header>
        <h1>Expense Splitter</h1>
        <button
          className="history-toggle"
          onClick={() => setView(view === 'wizard' ? 'history' : 'wizard')}
        >
          {view === 'wizard' ? 'History' : 'Back to Split'}
        </button>
      </header>
      {view === 'wizard' && <BillWizard />}
      {view === 'history' && <HistoryList onBack={() => setView('wizard')} />}
    </main>
  );
}
```

Import `useState` from React, `HistoryList` from components.

**Part D: Add CSS to `src/App.css`**

Add styles for history and save functionality:

```css
/* App header with history toggle */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

header h1 {
  margin-bottom: 0;
}

.history-toggle {
  background: transparent;
  color: #2563eb;
  font-size: 0.875rem;
  padding: 8px 12px;
  border: 1px solid #2563eb;
  min-height: 36px;
}

.history-toggle:hover {
  background: #eff6ff;
}

/* Save and New Split buttons */
.results-actions {
  display: flex;
  gap: 8px;
  margin-top: 1.5rem;
}

.save-history-btn {
  flex: 1;
  background: #16a34a;
}

.save-history-btn:hover {
  background: #15803d;
}

.save-history-btn.saved {
  background: #16a34a;
  opacity: 0.7;
}

.new-split-btn {
  flex: 1;
  background: #f3f4f6;
  color: #1a1a1a;
}

.new-split-btn:hover {
  background: #e5e7eb;
}

/* History List */
.history-list {
  /* container */
}

.history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.history-empty {
  text-align: center;
  color: #666;
  padding: 2rem 1rem;
}

.history-item {
  margin-bottom: 8px;
}

.history-item__summary {
  display: flex;
  justify-content: space-between;
  align-items: center;
  min-height: 44px;
  padding: 12px 16px;
  cursor: pointer;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  list-style: none;
}

.history-item__summary::-webkit-details-marker {
  display: none;
}

.history-item__summary:hover {
  background: #f9fafb;
}

.history-meta {
  font-size: 0.875rem;
  color: #666;
}

.history-item__details {
  padding: 12px 16px;
  border: 1px solid #e5e7eb;
  border-top: none;
  border-radius: 0 0 8px 8px;
  background: #fafafa;
  font-size: 0.875rem;
}

.history-delete-btn {
  background: transparent;
  color: #dc2626;
  font-size: 0.75rem;
  padding: 4px 8px;
  min-height: 32px;
  min-width: 32px;
}

.history-delete-btn:hover {
  background: #fee2e2;
}

.clear-history-btn {
  width: 100%;
  background: #f3f4f6;
  color: #dc2626;
  margin-top: 1rem;
  font-size: 0.875rem;
}

.clear-history-btn:hover {
  background: #fee2e2;
}

.clear-history-btn.confirming {
  background: #dc2626;
  color: white;
}
```

**Part E: Update tests**

Add to `src/components/ResultsStep.test.tsx`:
- Test: Save to History button calls saveBill with correct data
- Test: New Split button calls reset

Create `src/components/HistoryList.test.tsx`:
- Test: Renders empty state when no bills saved
- Test: Renders saved bill with total, people count, items count
- Test: Delete button removes bill from history
  </action>
  <verify>
Run `npx vitest run` -- all tests pass including new history tests.
Run `npx tsc --noEmit` -- zero TypeScript errors.
Run `npx vite build` -- builds successfully.
  </verify>
  <done>
Save to History button snapshots current bill state to historyStore. HistoryList displays past splits with date, total, and counts. Each history entry expands to show full breakdown. App shell toggles between wizard and history views. Delete and Clear All work correctly.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete Phase 5 flow on mobile viewport</name>
  <files>src/components/BillWizard.tsx</files>
  <action>
Ensure dev server is running (`npx vite dev` or confirm already running). This is a human verification checkpoint -- no code changes needed. The user will manually test the complete Phase 5 flow on a mobile viewport to verify all interactive behaviors work correctly.

What was built in Plan 01 and Plan 02 Task 1:
- 5-step wizard ending with Results summary showing per-person totals
- Each person's total expandable to see itemized breakdown (items, tax share, tip share)
- Save to History button stores completed split to historyStore
- History view shows past splits with expandable details
- New Split button resets bill and returns to People step
- App header toggles between wizard and history views
  </action>
  <verify>
Human verifies the following on mobile viewport (375px width in Chrome DevTools):

1. Open http://localhost:5173 in browser DevTools mobile viewport
2. Complete a full wizard flow:
   a. Add 3 people: Alice, Bob, Charlie
   b. Add 3 items: Pizza $15.00, Salad $8.50, Drinks $12.00
   c. Assign Pizza to Alice+Bob, Salad to Charlie, Drinks to all three
   d. Set tax rate to 8.5%, tip to 20%
   e. Tap "See Results" to reach step 5
3. Verify Results screen:
   a. Grand total displayed at top with subtotal, tax, tip breakdown
   b. Each person shows their name and total amount
   c. Tap a person's row to expand -- verify items listed with correct shares
   d. Verify tax share and tip share displayed in expanded view
   e. Verify sum of all person totals equals grand total (no missing pennies)
4. Test Save to History:
   a. Tap "Save to History" -- button should show "Saved!" briefly
   b. Tap "History" button in header -- verify saved split appears
   c. Tap the saved split to expand and see breakdown
   d. Tap "Back to Split" to return to wizard
5. Test New Split:
   a. Navigate back to Results step
   b. Tap "New Split" -- wizard should reset to People step
6. Verify all touch targets are >= 44px
7. Verify expandable sections work smoothly on mobile
  </verify>
  <done>
User types "approved" confirming all Phase 5 interactive behaviors work correctly on mobile viewport, or describes specific issues to fix.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` -- all tests pass
2. `npx tsc --noEmit` -- zero TypeScript errors
3. `npx vite build` -- production build succeeds
4. Human verified: full 5-step flow on mobile with correct calculations
5. Human verified: save to history and recall from history list
6. Human verified: expandable breakdowns show items, tax share, tip share
</verification>

<success_criteria>
- Save to History snapshots bill state via historyStore.saveBill
- HistoryList renders past splits with date, total, people/items count
- History entries expand to show full per-person breakdown
- App toggles between wizard and history views
- Delete individual history entries works
- Clear All History works with confirmation step
- New Split resets bill and returns to People step
- All touch targets >= 44px on mobile
- Human verified complete flow works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/05-results-and-history/05-02-SUMMARY.md`
</output>
