---
phase: 05-results-and-history
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/calculations/personTotals.ts
  - src/lib/calculations/personTotals.test.ts
  - src/components/ResultsStep.tsx
  - src/components/ResultsStep.test.tsx
  - src/components/BillWizard.tsx
  - src/components/BillWizard.test.tsx
  - src/App.css
autonomous: true

must_haves:
  truths:
    - "User sees summary screen with each person's total amount owed"
    - "User can expand each person's total to see itemized breakdown (items + tax share + tip share)"
    - "All calculations update instantly as user changes inputs (no calculate button)"
  artifacts:
    - path: "src/lib/calculations/personTotals.ts"
      provides: "Pure function computing per-person breakdowns from bill state"
      exports: ["computePersonTotals"]
    - path: "src/components/ResultsStep.tsx"
      provides: "Summary screen with expandable person totals"
      min_lines: 60
    - path: "src/components/BillWizard.tsx"
      provides: "5-step wizard with results as final step"
      contains: "results"
  key_links:
    - from: "src/lib/calculations/personTotals.ts"
      to: "src/lib/calculations/tax.ts"
      via: "calculateTax, distributeTax"
      pattern: "calculateTax|distributeTax"
    - from: "src/lib/calculations/personTotals.ts"
      to: "src/lib/calculations/tip.ts"
      via: "calculateTip, distributeTip"
      pattern: "calculateTip|distributeTip"
    - from: "src/lib/calculations/personTotals.ts"
      to: "src/lib/calculations/split.ts"
      via: "splitEqually for equal item splits"
      pattern: "splitEqually"
    - from: "src/components/ResultsStep.tsx"
      to: "src/lib/calculations/personTotals.ts"
      via: "import computePersonTotals"
      pattern: "computePersonTotals"
    - from: "src/components/ResultsStep.tsx"
      to: "src/stores/billStore.ts"
      via: "usePeople, useItems, useAssignments, useTaxInput, useTipRate"
      pattern: "usePeople|useItems|useAssignments|useTaxInput|useTipRate"
---

<objective>
Build the ResultsStep component showing each person's total with expandable itemized breakdowns, and extend BillWizard to 5 steps.

Purpose: This is the payoff screen -- users see exactly what each person owes after entering all bill data. Per-person totals are derived in real-time from store state using Phase 1 calculation functions (no stored calculations, no sync bugs).

Output: ResultsStep component, computePersonTotals utility, 5-step wizard
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/calculations/tax.ts
@src/lib/calculations/tip.ts
@src/lib/calculations/split.ts
@src/lib/calculations/allocate.ts
@src/lib/types/bill.ts
@src/lib/types/money.ts
@src/stores/billStore.ts
@src/components/BillWizard.tsx
@src/App.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create computePersonTotals utility and ResultsStep component</name>
  <files>
    src/lib/calculations/personTotals.ts
    src/lib/calculations/personTotals.test.ts
    src/components/ResultsStep.tsx
    src/components/ResultsStep.test.tsx
  </files>
  <action>
**Part A: Create `src/lib/calculations/personTotals.ts`**

Create a pure function `computePersonTotals` that derives per-person breakdowns from bill state. This is the critical wiring between Phase 1 calculations and Phase 5 display.

Function signature:
```ts
interface PersonItemDetail {
  itemId: string;
  itemName: string;
  fullPriceInCents: Cents;    // Original item price
  shareInCents: Cents;         // What this person pays for this item
  splitCount: number;          // How many people share this item
  isCustomSplit: boolean;      // Whether custom split is used
}

interface PersonBreakdown {
  personId: string;
  personName: string;
  items: PersonItemDetail[];
  itemsSubtotal: Cents;       // Sum of all item shares
  taxShare: Cents;
  tipShare: Cents;
  total: Cents;                // itemsSubtotal + taxShare + tipShare
}

interface BillSummary {
  personBreakdowns: PersonBreakdown[];
  billSubtotal: Cents;         // Sum of all item prices
  totalTax: Cents;
  totalTip: Cents;
  grandTotal: Cents;
}

export function computePersonTotals(
  people: Person[],
  items: Item[],
  assignments: Record<string, Assignment>,
  taxInput: TaxInput | null,
  tipRate: number
): BillSummary
```

Implementation logic:
1. For each person, find their items by scanning assignments where personIds includes their id
2. For each item assigned to a person:
   - If assignment has `customSplit`: find this person's entry, use `amountInCents` as their share
   - If no customSplit (equal split): use `splitEqually(item.priceInCents, assignment.personIds.length)` and take the share at this person's index in personIds array (to match the deterministic first-person-priority remainder distribution)
3. Compute each person's `itemsSubtotal` as sum of their item shares
4. Compute `billSubtotal` as sum of ALL item prices (not person subtotals -- items may be unassigned)
5. Compute `totalTax`: if taxInput is not null, call `calculateTax(billSubtotal, taxInput)`, else 0
6. Compute `totalTip`: call `calculateTip(billSubtotal, tipRate)`
7. Build array of person subtotals (in same order as people array)
8. Distribute tax: if totalTax > 0 and any person has itemsSubtotal > 0, call `distributeTax(totalTax, personSubtotals)`, else array of zeros
9. Distribute tip: if totalTip > 0 and any person has itemsSubtotal > 0, call `distributeTip(totalTip, personSubtotals)`, else array of zeros
10. For each person: total = itemsSubtotal + taxShare + tipShare
11. grandTotal = sum of all person totals

Import from: `splitEqually` from `../calculations/split`, `calculateTax`/`distributeTax` from `../calculations/tax`, `calculateTip`/`distributeTip` from `../calculations/tip`, types from `../types/bill` and `../types/money`.

Edge cases to handle:
- No assignments yet: all breakdowns show $0.00
- Some items unassigned: those items don't appear in anyone's breakdown, but billSubtotal still includes them (tax/tip calculated on full bill)
- Person with no items assigned: shows $0.00 with empty items array, zero tax/tip shares
- All subtotals zero (no items assigned to anyone): skip distributeTax/distributeTip (would throw on zero totals), return zero shares

**Part B: Create `src/lib/calculations/personTotals.test.ts`**

Write 5-7 tests:
1. Basic: 2 people, 2 items, each assigned one item, 10% tax rate, 20% tip -- verify correct totals
2. Shared item: 3 people share one item equally -- verify splitEqually is used correctly
3. Custom split: 2 people share item with custom percentages -- verify custom amounts used
4. No assignments: all people show $0.00 totals
5. Mixed: some items assigned, some not -- verify unassigned items excluded from person breakdowns but included in bill subtotal for tax/tip
6. Grand total equals sum of person totals (sum invariant)

Use the localStorage mock pattern from existing tests (globalThis).

**Part C: Create `src/components/ResultsStep.tsx`**

React component that reads store state and displays computed results.

```tsx
export function ResultsStep() {
  // Read all store state via selector hooks
  const people = usePeople();
  const items = useItems();
  const assignments = useAssignments();
  const taxInput = useTaxInput();
  const tipRate = useTipRate();

  // Derive totals (no useState, no useEffect -- direct computation per research guidance)
  const summary = computePersonTotals(people, items, assignments, taxInput, tipRate);

  // Render summary
}
```

Use `formatCurrency` from `src/lib/types/money.ts` (already exists, do NOT create a new one).

Structure:
- Bill overview header showing grand total, subtotal, tax, tip
- List of PersonTotal sections using native `<details>`/`<summary>` HTML elements
- Each `<details>` shows person name + total on the `<summary>` line
- Expanded content shows:
  - Items list with item name and person's share amount (show "1/N" or "custom" indicator)
  - Tax share line
  - Tip share line
  - Total line (bold)
- If no items are assigned to anyone, show a helpful message: "Assign items to people to see the breakdown"

Use CSS class names: `.results-step`, `.bill-overview`, `.overview-row`, `.person-total`, `.person-total__summary`, `.person-total__breakdown`, `.breakdown-item`, `.share-line`, `.total-line`

**Part D: Create `src/components/ResultsStep.test.tsx`**

Write 3-4 tests using the Zustand store testing pattern from existing component tests:
1. Renders person names and totals
2. Shows "no assignments" message when nothing assigned
3. Renders expandable details with item breakdown

Follow the testing patterns in existing component tests (e.g., TaxTipStep.test.tsx).
  </action>
  <verify>
Run `npx vitest run` -- all existing tests pass plus new personTotals and ResultsStep tests.
Run `npx tsc --noEmit` -- zero TypeScript errors.
  </verify>
  <done>
computePersonTotals correctly derives per-person breakdowns using Phase 1 calculation functions (splitEqually, calculateTax, distributeTax, calculateTip, distributeTip). ResultsStep renders each person's total with expandable itemized breakdown. Sum of person totals equals grand total (no lost pennies).
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend BillWizard to 5 steps with Results as final step</name>
  <files>
    src/components/BillWizard.tsx
    src/components/BillWizard.test.tsx
    src/App.css
  </files>
  <action>
**Part A: Update `src/components/BillWizard.tsx`**

1. Import ResultsStep: `import { ResultsStep } from '@/components/ResultsStep';`
2. Update WizardStep type: `'people' | 'items' | 'assignment' | 'taxtip' | 'results'`
3. Update STEPS array: `['people', 'items', 'assignment', 'taxtip', 'results']`
4. Update stepLabels: add `results: 'Results'`
5. Add canProceed for results: `results: true` (results step is always valid -- it's the final display)
6. Add rendering case: `{currentStep === 'results' && <ResultsStep />}`
7. Update auto-advance logic: if all previous 4 steps pass their gates, advance to 'results'
8. Change the "Next" button on the taxtip step: it should say "See Results" instead of "Next" when advancing to the final step. Add logic: if currentStep is the second-to-last step (taxtip), button text is "See Results", otherwise "Next".
9. On the results step (isLastStep), hide the "Next" button entirely since there's nowhere to go. The "Back" button should still work to go back to Tax & Tip.

**Part B: Update `src/components/BillWizard.test.tsx`**

1. Update STEPS ordering test to verify 5 steps: ['people', 'items', 'assignment', 'taxtip', 'results']
2. Update stepLabels test if exists
3. Add test: results step renders when navigated to (set up store with valid state for all prior gates)
4. Update auto-advance test: with all 4 prior gates passing, should advance to 'results'

**Part C: Add CSS to `src/App.css`**

Add ResultsStep styles at the bottom of App.css (after existing Tax & Tip section):

```css
/* Results Step */
.results-step {
  /* Container */
}

.bill-overview {
  margin-bottom: 1.5rem;
  padding: 12px;
  background: #f9fafb;
  border-radius: 8px;
}

.overview-row {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  font-size: 0.9375rem;
}

.overview-row.grand-total {
  font-weight: bold;
  font-size: 1.125rem;
  padding-top: 8px;
  margin-top: 8px;
  border-top: 1px solid #ddd;
}

.person-total {
  margin-bottom: 8px;
}

.person-total__summary {
  display: flex;
  justify-content: space-between;
  align-items: center;
  min-height: 44px;
  padding: 12px 16px;
  cursor: pointer;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  font-size: 1rem;
  list-style: none;  /* Remove default triangle on Safari */
}

.person-total__summary::-webkit-details-marker {
  display: none;  /* Remove default triangle on Chrome/Safari */
}

.person-total__summary::before {
  content: '\25B6';  /* Right-pointing triangle */
  font-size: 0.75rem;
  margin-right: 8px;
  transition: transform 0.2s;
}

details[open] > .person-total__summary::before {
  transform: rotate(90deg);
}

.person-total__summary:hover {
  background: #f9fafb;
}

.person-total__name {
  font-weight: 500;
}

.person-total__amount {
  font-weight: 600;
  font-variant-numeric: tabular-nums;
}

.person-total__breakdown {
  padding: 12px 16px;
  margin-top: -1px;
  border: 1px solid #e5e7eb;
  border-top: none;
  border-radius: 0 0 8px 8px;
  background: #fafafa;
}

.breakdown-item {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  font-size: 0.875rem;
  border-bottom: none !important;  /* Override global li border */
}

.breakdown-item .split-indicator {
  color: #666;
  font-size: 0.75rem;
}

.share-line {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  font-size: 0.875rem;
  color: #666;
}

.total-line {
  display: flex;
  justify-content: space-between;
  padding: 8px 0 0 0;
  margin-top: 8px;
  border-top: 1px solid #ddd;
  font-weight: 600;
}

.results-empty {
  text-align: center;
  color: #666;
  padding: 2rem 1rem;
}

/* Results step -- person total spacing */
.person-total + .person-total {
  margin-top: 8px;
}
```

Ensure 44px touch targets on summary elements. Use font-variant-numeric: tabular-nums for amounts (consistent column alignment).
  </action>
  <verify>
Run `npx vitest run` -- all tests pass including updated BillWizard tests.
Run `npx tsc --noEmit` -- zero TypeScript errors.
Run `npx vite build` -- builds successfully.
  </verify>
  <done>
BillWizard displays 5 steps. Tax & Tip step shows "See Results" button. Results step renders with expandable per-person breakdowns. Back button on results navigates to Tax & Tip. Auto-advance works for all 5 steps.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` -- all tests pass (existing + new personTotals + ResultsStep + updated BillWizard)
2. `npx tsc --noEmit` -- zero TypeScript errors
3. `npx vite build` -- production build succeeds
4. Manual: Navigate through full 5-step wizard, verify results show correct per-person totals with expandable breakdowns
</verification>

<success_criteria>
- computePersonTotals derives correct per-person breakdowns using Phase 1 functions
- Sum invariant holds: sum of person totals = grand total (no lost pennies)
- ResultsStep shows each person's total with expandable itemized breakdown
- Native `<details>`/`<summary>` elements provide accessible expand/collapse
- BillWizard shows 5 steps with "See Results" on final navigation
- Calculations derived in render (no stored state, no useEffect sync)
- All amounts formatted with formatCurrency from money.ts
- 44px touch targets on expandable summaries
</success_criteria>

<output>
After completion, create `.planning/phases/05-results-and-history/05-01-SUMMARY.md`
</output>
